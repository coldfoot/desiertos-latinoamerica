const corresp = {
    "HIRING": {
        "argentina": {
            "CONTRATO INDEFINIDO": "Relaci\u00f3n de dependencia",
            "CONTRATO LIMITADO": "Contrato por tiempo limitado",
            "PRACTICA PROFESIONAL": "Pasant\u00eda",
            "CONTRATO POR PIEZAS": "Contrato por piezas/producciones/coberturas",
            "TRABAJO INDEPENDIENTE": "Cuentapropismo",
            "EMPLEO INFORMAL": "Empleo no registrado",
            "COMISI\u00d3N": "Venta de publicidad o de espacios",
            "TRABAJO VOLUNTARIO": "Trabajo voluntario",
            "OTRAS": "Otras formas de relaci\u00f3n"
        },
        "mexico": {
            "CONTRATO INDEFINIDO": "Contrato formal por tiempo indefinido",
            "CONTRATO LIMITADO": "Contrato formal por tiempo determinado",
            "PRACTICA PROFESIONAL": "Pr\u00e1ctica profesional",
            "CONTRATO POR PIEZAS": "Contrato por notas/producciones/coberturas",
            "TRABAJO INDEPENDIENTE": "Trabajo independiente",
            "EMPLEO INFORMAL": "Empleo informal",
            "COMISI\u00d3N": "Comisi\u00f3n o venta de publicidad o espacios",
            "TRABAJO VOLUNTARIO": "Trabajo voluntario",
            "OTRAS": "Otras formas de relaci\u00f3n"
        },
        "peru": {
            "CONTRATO INDEFINIDO": "Contrato formal por tiempo indefinido",
            "CONTRATO LIMITADO": "Contrato formal por tiempo determinado",
            "PRACTICA PROFESIONAL": "Pr\u00e1ctica profesional",
            "CONTRATO POR PIEZAS": "Contrato por notas/producciones/coberturas",
            "TRABAJO INDEPENDIENTE": "Trabajo independiente",
            "EMPLEO INFORMAL": "Empleo no registrado",
            "COMISI\u00d3N": "Comisi\u00f3n o venta de publicidad o espacios",
            "TRABAJO VOLUNTARIO": "Trabajo voluntario",
            "OTRAS": "Otras formas de relaci\u00f3n"
        },
        "chile": {
            "CONTRATO INDEFINIDO": "Contrato indefinido",
            "CONTRATO LIMITADO": "Contrato por tiempo limitado",
            "PRACTICA PROFESIONAL": "Pr\u00e1ctica profesional",
            "CONTRATO POR PIEZAS": "Contrato por piezas/producciones/coberturas",
            "TRABAJO INDEPENDIENTE": "Trabajo independiente",
            "EMPLEO INFORMAL": "Empleo informal",
            "COMISI\u00d3N": "Comisi\u00f3n o venta de publicidad o espacios",
            "TRABAJO VOLUNTARIO": "Trabajo voluntario",
            "OTRAS": "Otras formas de relaci\u00f3n"
        }
    },
    "PLATFORMS": {
        "all": {
            "BLOG": "Blog",
            "NEWSLETTER": "Bolet\u00edn de noticias o newsletter",
            "TELEGRAM": "Canal de Telegram",
            "TV": "Canal de televisi\u00f3n",
            "TWITCH": "Canal de Twitch",
            "WHATSAPP": "Canal de WhatsApp",
            "YOUTUBE": "Canal de Youtube",
            "INSTAGRAM": "Cuenta en Instagram",
            "TIKTOK": "Cuenta en TikTok",
            "X": "Cuenta en X",
            "RADIO": "Estaci\u00f3n de radio",
            "FACEBOOK": "P\u00e1gina o perfil en Facebook",
            "PRINT": "Peri\u00f3dico impreso",
            "PODCAST": "P\u00f3dcast",
            "REVISTA": "Revista",
            "WEBSITE": "Sitio web",
            "OTRAS": "Otras plataformas"
        }
    },
    "INCOME": {
        "argentina": {
            "CROWDFUNDING": "Campa\u00f1as de recaudaci\u00f3n colectiva (crowdfunding)",
            "PUBLIREPORTAJES": "Contenido patrocinado y/o publireportajes",
            "CONTENIDO PARA CLIENTES": "Creaci\u00f3n de contenido para clientes",
            "DONACIONES PARTICULARES": "Donaciones particulares",
            "FINANCIACI\u00d3N P\u00daBLICA": "Financiaci\u00f3n p\u00fablica",
            "MEMBRES\u00cdAS": "Membres\u00edas",
            "ORGANIZACI\u00d3N DE EVENTOS": "Organizaci\u00f3n de eventos",
            "PAUTA DE VENTA DIRECTA": "Pauta de venta directa",
            "PAUTA PROGRAM\u00c1TICA": "Pauta program\u00e1tica",
            "CONSULTOR\u00cdA": "Servicios de consultor\u00eda",
            "SERVICIOS DE FORMACI\u00d3N": "Servicios de formaci\u00f3n (venta de cursos, talleres, capacitaciones)",
            "SUBSIDIOS O GRANTS": "Subsidios o Grants",
            "SUBSCRIPCIONES": "Subscripciones",
            "VENTA DE PRODUCTOS": "Venta de productos f\u00edsicos o digitales",
            "OTRAS": "Otras fuentes de ingresos"
        },
        "mexico": {
            "CROWDFUNDING": "Campa\u00f1as de recaudaci\u00f3n colectiva (crowdfunding)",
            "PUBLIREPORTAJES": "Contenido patrocinado y/o publireportajes",
            "CONTENIDO PARA CLIENTES": "Creaci\u00f3n de contenido para clientes",
            "DONACIONES PARTICULARES": "Donaciones particulares",
            "FINANCIACI\u00d3N P\u00daBLICA": "Financiaci\u00f3n p\u00fablica",
            "MEMBRES\u00cdAS": "Membres\u00edas",
            "ORGANIZACI\u00d3N DE EVENTOS": "Organizaci\u00f3n de eventos",
            "PAUTA DE VENTA DIRECTA": "Pauta de venta directa",
            "PAUTA PROGRAM\u00c1TICA": "Pauta program\u00e1tica automatizada",
            "CONSULTOR\u00cdA": "Servicios de consultor\u00eda",
            "SERVICIOS DE FORMACI\u00d3N": "Servicios de formaci\u00f3n (venta de cursos, talleres, capacitaciones)",
            "SUBSIDIOS O GRANTS": "Subsidios o subvenciones",
            "SUBSCRIPCIONES": "Suscripciones",
            "VENTA DE PRODUCTOS": "Venta de productos f\u00edsicos o digitales",
            "OTRAS": "Otras fuentes de ingresos"
        },
        "peru": {
            "CROWDFUNDING": "Campa\u00f1as de recaudaci\u00f3n colectiva (crowdfunding)",
            "PUBLIREPORTAJES": "Contenido patrocinado y/o publireportajes",
            "CONTENIDO PARA CLIENTES": "Creaci\u00f3n de contenido para clientes",
            "DONACIONES PARTICULARES": "Donaciones particulares",
            "FINANCIACI\u00d3N P\u00daBLICA": "Financiaci\u00f3n p\u00fablica",
            "MEMBRES\u00cdAS": "Membres\u00edas",
            "ORGANIZACI\u00d3N DE EVENTOS": "Organizaci\u00f3n de eventos",
            "PAUTA DE VENTA DIRECTA": "Pauta de venta directa",
            "PAUTA PROGRAM\u00c1TICA": "Pauta program\u00e1tica automatizada",
            "CONSULTOR\u00cdA": "Servicios de consultor\u00eda",
            "SERVICIOS DE FORMACI\u00d3N": "Servicios de formaci\u00f3n (venta de cursos, talleres, capacitaciones)",
            "SUBSIDIOS O GRANTS": "Subvenciones",
            "SUBSCRIPCIONES": "Subscripciones",
            "VENTA DE PRODUCTOS": "Venta de productos f\u00edsicos o digitales",
            "OTRAS": "Otras fuentes de ingresos"
        },
        "chile": {
            "CROWDFUNDING": "Campa\u00f1as de recaudaci\u00f3n colectiva (crowdfunding)",
            "PUBLIREPORTAJES": "Contenido patrocinado y/o publireportajes",
            "CONTENIDO PARA CLIENTES": "Creaci\u00f3n de contenido para clientes",
            "DONACIONES PARTICULARES": "Donaciones particulares",
            "FINANCIACI\u00d3N P\u00daBLICA": "Financiaci\u00f3n p\u00fablica",
            "MEMBRES\u00cdAS": "Membres\u00edas",
            "ORGANIZACI\u00d3N DE EVENTOS": "Organizaci\u00f3n de eventos",
            "PAUTA DE VENTA DIRECTA": "Pauta de venta directa",
            "PAUTA PROGRAM\u00c1TICA": "Pauta program\u00e1tica",
            "CONSULTOR\u00cdA": "Servicios de consultor\u00eda",
            "SERVICIOS DE FORMACI\u00d3N": "Servicios de formaci\u00f3n (venta de cursos, talleres, capacitaciones)",
            "SUBSIDIOS O GRANTS": "Subsidios o Grants",
            "SUBSCRIPCIONES": "Subscripciones",
            "VENTA DE PRODUCTOS": "Venta de productos f\u00edsicos o digitales",
            "OTRAS": "Otras fuentes de ingresos"
        }
    },
    "THEMES": {
        "all": {
            "DERECHOS": "Derechos y justicia social",
            "ECONOMÍA": "Economía y desarrollo local",
            "EMERGENCIAS": "Emergencias y desastres",
            "GOBIERNO": "Gobierno y política local",
            "INVESTIGACIÓN": "Investigación y vigilancia del poder",
            "MEDIO AMBIENTE": "Medio ambiente y sostenibilidad",
            "SERVICIOS": "Servicios públicos y desarrollo urbano",
            "SEGURIDAD": "Seguridad y convivencia",
            "SOCIAL": "Temas sociales y calidad de vida",
            "OTRAS": "Otras temáticas"
        }
    },
    "THREATS": {
        "all": {
            "FÍSICAS": "Agresiones físicas graves",
            "AMENAZAS DIRECTAS": "Amenazas directas",
            "AMENAZAS DIGITALES": "Amenazas digitales",
            "CRIMEN ORGANIZADO": "Presiones del crimen organizado",
            "ECONÓMICAS": "Presiones económicas",
            "GOBIERNO": "Presiones gubernamentales",
            "JUDICIAL": "Acoso judicial",
            "NO RESPONDE": "Prefiero no responder",
            "NO RECIBE": "No recibimos agresiones ni amenazas",
            "OTRAS": "Otras amenazas"
        }
    }
};

const topics = {

    "HIRING" : {

        title : '¿Qué tipo de vínculo laboral tienen los periodistas?',

        //subtitle : "<span data-viz-subtitle-field='highest-pct'></span> de los <span data-viz-subtitle-field='higher-pct'></span> medios de <span data-viz-subtitle-field='unit name'></span> contratan periodistas por meio de <span data-viz-subtitle-field='highest-pct-category'></span>, enquanto en <span data-viz-subtitle-field='upper unit name'> esta porcentaje es de <span data-viz-subtitle-field='upper unit value'>",
        subtitle: "Porcentaje de medios que contratan periodistas mediante los seguientes vínculos laborales, por localidad"
    },

    'PLATFORMS' : {

        title : '¿En qué plataforma publican los medios?',

        subtitle : 'Porcentaje de medios que publican en las seguientes plataformas, por localidad'

    },

    "INCOME" : {

        title : '¿De dónde provienen sus ingresos?',

        subtitle : 'Porcentaje de medios que tienen las siguientes fuentes de ingresos, por localidad'

    },

    "THEMES" : {

        title : '¿Cuáles son las temáticas de su agenda informativa?',

        subtitle : 'Porcentaje de medios que tienen las seguientes temáticas en su agenda informativa, por localidad'

    },

    "THREATS" : {

        title : '¿Experimentaron agresiones o amenazas en 2024?',

        subtitle : 'Porcentaje de medios cuyos periodistas experimentarón los siguientes tipos de agresiones o amenazas, por localidad'

    }

    

}

let summary_data;

function gen_csv() {

    const output = [];
    const categories = summary_data.categories;
    const units = summary_data.data[categories[0]].map(d => d.name);

    const header = ["Pais", "Provincia / Estado", "Localidad / Cidade", "Topico", ...categories];
    output.push(header);


    units.forEach(unit => {

        const values = categories.map(category => summary_data.data[category].filter(d => d.name == unit)[0].value)

        const row = [summary_data.header.country, summary_data.header.provincia, summary_data,header.topic, unit, ...values];
        const row_string = row.join(" ; ");
        output.push(row_string);

    })

    const output_string = output.join("\n");

    const blob = new Blob([output_string], { type: 'text/csv' });

    const url = URL.createObjectURL(blob);

    return url

}

function prepare_download_datos_btn(ref) {

    const btn = document.querySelector(ref);

    const url = gen_csv();
    btn.href = url;
    btn.download = `datos_${summary_data.header.country}_${summary_data.header.provincia}${summary_data.header.topic}.csv`;

    console.log(btn, btn.download);

    //btn.click();

    //setTimeout(() => URL.revokeObjectURL(url), 100);


}



function visualize_topic(country, topic, level, provincia = undefined, localidad = undefined) {

    const title = document.querySelector(".viz-main-title");
    const subtitle = document.querySelector(".viz-subtitle");
    const global_container = document.querySelector(".minicharts-global-container");

    title.innerHTML = topics[topic].title;
    subtitle.innerHTML = topics[topic].subtitle;
    global_container.innerHTML = "";

    const summary = prepare_data(country, topic, level, provincia, localidad);

    console.log(provincia);
    
    // data for the download button
    summary_data = summary;
    summary_data["header"] = {
        country,
        provincia,
        topic
    };


    const data = summary.data;
    const categories = summary.categories;

    categories.forEach(category => {

        const chart = new Chart(
            topic,
            category,
            data[category]
        )

    })

    prepare_download_datos_btn(".modal-viz-descargar-datos");



}

// will need access to main_data variable
function prepare_data(country, topic, level, provincia = undefined, localidad = undefined) {
    const startTime = performance.now();

    let pre_data;

    if (level == "pais") {

        pre_data = main_data[country]["large_units"];

    } else {

        pre_data = main_data[country]["small_units"].filter(d => d.BASIC_INFO.PARENT == provincia);

    }

    const prepared_data = {};

    const categories = Object.keys(main_data[country].country[0][topic]).filter(d => d.slice(-3) == "PCT");

    categories.forEach(category => {

        prepared_data[category] = pre_data.map(
            function(unit) {

                // para destacar o próprio local
                let flag_self;

                /*
                if (level == "provincia") {
                    if (unit.BASIC_INFO.NAME == provincia) {
                        flag_self = true;
                    }
                }*/

                if (level == "localidad") {
                    if (unit.BASIC_INFO.NAME == localidad) {
                        flag_self = true;
                    }
                }

                return ({

                    "name" : unit.BASIC_INFO.NAME,
                    "value" : unit[topic][category],
                    "type" : flag_self ? "highlight" : ""

                })

            } 
        )

        // adiciona a media do país
        prepared_data[category].push({
            "name" : "Promedio " + country,
            "value" : main_data[country].country[0][topic][category],
            "type" : "promedio-country"
        })

        if (level != "pais") {

            // adiciona a media da provincia
            prepared_data[category].push({
                "name" : "Promedio " + provincia,
                "value" : main_data[country].large_units.filter(d => d.BASIC_INFO.NAME == provincia)[0][topic][category],
                "type" : "promedio-provincia"
            })

        }

    })

    return {
        categories: categories,
        data: prepared_data
    }

}

class Chart {

    constructor(topic, category, data) {

        this.data = data;

        this.h = 100;
        this.w = 300;
        this.ml = 20; // lateral margin
        this.label_height = 15;
        this.mtop = 2 * this.label_height; // vertical margin
        this.strip_length = 40;
        this.gap = 5;

        this.strip_width = 3;
        this.strip_opacity = 0.2;

        this.y1 = this.mtop;
        this.y2 = this.mtop + this.strip_length;

        this.container = d3.select(".minicharts-global-container");

        this.category = category;
        this.category_adjusted = category.replace("_PCT", "").replace("_", " ");

        this.topic = topic;

        this.prepare_elements();
        this.make_scales();
        this.make_background();
        this.draw();
        this.make_axis();
        this.adds_labels();
        this.adds_interaction(this);

    }

    prepare_elements() {

        this.chart = this.container.append("div");
        this.chart.classed("mini-chart-container", true);

        let corresp_atual = corresp[this.topic]["all"] ?
            corresp[this.topic]["all"] :
            corresp[this.topic][current_country]
        ;

        this.chart.append("h4").classed("mini-chart-title", true).text(
            //this.category_adjusted
            corresp_atual[this.category.slice(0,-4)]
        );

        this.tooltipContainer = this.chart.append("div");
        this.tooltipContainer.classed("mini-chart-tooltip-container", true);

        this.tooltip = this.tooltipContainer.append("span")
            .classed("mini-chart-tooltip", true)
            .style("top", 0)
        ;

        this.svg = this.tooltipContainer.append("svg");
        this.svg
            .classed("mini-chart", true)
            .attr("data-mini-chart-category", this.category)
            .attr("viewBox", `0 0 ${this.w} ${this.h}`)
            .attr("width", this.w)
            .attr("height", this.h)
        ;

        this.promedio_country_label = this.tooltipContainer.append("span").classed("minichart-promedio-country-label", true);
        this.promedio_provincia_label = this.tooltipContainer.append("span").classed("minichart-promedio-provincia-label", true);

    }

    make_scales() {

        this.x = d3.scaleLinear()
            .domain([0, 1])
            .range([this.ml, this.w - this.ml])
        ;

    }

    make_background() {

        this.svg.append("rect")
           .classed("striplot-bg", true)
           .attr("x", this.x(0))
           .attr("width", this.x(1)-this.x(0))
           .attr("y", this.y1)
           .attr("height", this.strip_length)
        ;

    }

    draw() {

        this.strips = this.svg.selectAll("line.strip")
            .data(this.data)
            .join("line")
            .classed("strip", true)
            .attr("data-strip-type", d => d.type)
            .attr("stroke-width", this.strip_width)
            .attr("opacity", this.strip_opacity)
            .attr("x1", d => this.x(d.value))
            .attr("x2", d => this.x(d.value))
            .attr("y1", d => (d.type.search("promedio") > -1 ) ? this.y1 - this.label_height : this.y1)
            .attr("y2", this.y2)
        ;

    }

    make_axis() {

        const ticks = [
            {
                value : 0,
                label : "0%"
             }, 
            {
                value : 1,
                label : "100%"
            }];

        this.ticks = this.svg.selectAll("line.tick")
            .data(ticks)
            .join("line")
            .classed("tick", true)
            .attr("x1", d => this.x(d.value))
            .attr("x2", d => this.x(d.value))
            .attr("y1", this.y2 + this.gap)
            .attr("y2", this.y2 + 2.5*this.gap)
        ;

        this.labels = this.svg.selectAll("text.label")
            .data(ticks)
            .join("text")
            .classed("label", true)
            .attr("x", d => this.x(d.value))
            .attr("y", this.y2 + 4 * this.gap)
            .text(d => d.label)
        ;        

    }

    adds_labels() {

        const strip_promedio_country = this.svg.select("[data-strip-type='promedio-country']");
        this.promedio_country_label
            .style("top", strip_promedio_country.attr("y1") + "px")
            .style("left", strip_promedio_country.attr("x1") + "px")
            .text(strip_promedio_country.datum().name.replace("Promedio ", ""))
        ;

        // first check if there is a strip for the provincia (There won't be one if the level is "pais")
        if (this.svg.select("[data-strip-type='promedio-provincia']").nodes().length > 0) {

            const strip_promedio_provincia = this.svg.select("[data-strip-type='promedio-provincia']");
            this.promedio_provincia_label
                .style("top", strip_promedio_provincia.attr("y1") + "px")
                .style("left", strip_promedio_provincia.attr("x1") + "px")
                .text(strip_promedio_provincia.datum().name.replace("Promedio ", ""))
            ;

            // checks which one needs to go right or left

            if (+strip_promedio_country.attr("x1") > +strip_promedio_provincia.attr("x1")) {
                this.promedio_provincia_label.classed("make-left", true);
            } else {
                this.promedio_country_label.classed("make-left", true)
            }

        }

    }

    adds_interaction(self) {
        
        this.strips.on("mouseover", function(e) {

            const d = d3.select(this).datum();

            d3.select(this).transition().duration(100)
                .attr("y1", 0)
                .attr("stroke-width", 4)
                .attr("opacity", 1)
            ;

            self.showTooltip(true, d);



        })

        this.strips.on("mousemove", function(e) {

            const d = d3.select(this).datum();

            d3.select(this).transition().duration(100)
                .attr("y1", 0)
                .attr("stroke-width", 4)
                .attr("opacity", 1)
            ;

            self.showTooltip(true, d);

        })

        this.strips.on("mouseout", function(e) {

            const d = d3.select(this).datum();

            d3.select(this).transition().duration(100)
                .attr("y1", (d.type.search("promedio") > -1 ) ? self.y1 - self.label_height : self.y1)
                .attr("stroke-width", self.strip_width)
                .attr("opacity", self.strip_opacity)
            ;

            self.showTooltip(false);

        })

    }

    showTooltip(mode = true, d) {

        this.tooltip.classed("tooltip-visible", mode);
        
        if (d) {
            this.tooltip.text(d.name + ': ' + (d.value * 100).toFixed(2) + "%");
            this.tooltip
                .style("left", this.x(d.value) + "px")
                .classed("make-left", (this.x(d.value) > this.w/2) )
        }

    }

}
